===================
Convert to Solr XML
===================



We need to set the site since we're a functional test:

>>> import zope.app.component.hooks
>>> old_site = zope.app.component.hooks.getSite()
>>> zope.app.component.hooks.setSite(getRootFolder())


Get article for adapter tests:

>>> import zeit.cms.interfaces
>>> article = zeit.cms.interfaces.ICMSContent(
...     'http://xml.zeit.de/online/2007/01/Somalia')

Build a converter:

>>> import zeit.solr.interfaces
>>> article_converter = zeit.solr.interfaces.ISolrConverter(article)
>>> article_converter
<zeit.solr.converter.SolrConverter object at 0xc5f02ac>


Convert an article and check resultset:

>>> import lxml.etree
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add xmlns:py="http://codespeak.net/lxml/objectify/pytype" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <doc>
    <field ...
    <field name="icon" py:pytype="str">/@@/zeit-content-article-interfaces-IArticle-zmi_icon.png</field>...
  </doc>
</add>
<BLANKLINE>


Convert an image and check resultset:
(TODO: Use image with dav properties!)

>>> image = zeit.cms.interfaces.ICMSContent(
... 'http://xml.zeit.de/2006/DSC00109_2.JPG')
>>> image_converter = zeit.solr.interfaces.ISolrConverter(image)
>>> root_node = image_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add xmlns:py="http://codespeak.net/lxml/objectify/pytype" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <doc>
    <field ...
  </doc>
</add>
<BLANKLINE>


Convert a centerpage and check resultset:
(TODO: Use centerpage with dav properties!)

>>> cp = zeit.cms.interfaces.ICMSContent(
...     'http://xml.zeit.de/online/2007/01/index')
>>> cp_converter = zeit.solr.interfaces.ISolrConverter(cp)
>>> root_node = cp_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add xmlns:py="http://codespeak.net/lxml/objectify/pytype" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <doc>
    <field ...
  </doc>
</add>
<BLANKLINE>



Get a date
>>> import datetime
>>> import pytz
>>> date = datetime.datetime.now(tz=pytz.UTC)
>>> date
datetime.datetime...

Checkout article, change last semantic change to date, checkin
>>> import zeit.cms.testing
>>> principal = zeit.cms.testing.create_interaction() 
>>> dummy = with_statement
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date

>>> root_node = article_converter.convert()
>>> doc_node = root_node.doc
>>> print (doc_node.tag)
doc

Now we are doing some boosting. For today:  
>>> date = datetime.datetime.now(tz=pytz.UTC)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="6.0">...
...<field name="boost" py:pytype="float">6.0</field>...
<BLANKLINE>

For day 1
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=1)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="5.0">...
...<field name="boost" py:pytype="float">5.0</field>...
<BLANKLINE>

For day 6
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=6)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="3.0">...
...<field name="boost" py:pytype="float">3.0</field>...
<BLANKLINE>

For day 7
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=7)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="2.0">...
...<field name="boost" py:pytype="float">2.0</field>...
<BLANKLINE>

For day 20
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=20)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="2.0">...
...<field name="boost" py:pytype="float">2.0</field>...
<BLANKLINE>

For day 30
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=30)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="1.0">...
...<field name="boost" py:pytype="float">1.0</field>...
<BLANKLINE>

For day 70
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=70)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc>...
<BLANKLINE>

Clean up:
>>> zope.app.component.hooks.setSite(old_site)




