===================
Convert to Solr XML
===================



We need to set the site since we're a functional test:

>>> import zope.app.component.hooks
>>> old_site = zope.app.component.hooks.getSite()
>>> zope.app.component.hooks.setSite(getRootFolder())


Get article for adapter tests:

>>> import zeit.cms.interfaces
>>> article = zeit.cms.interfaces.ICMSContent(
...     'http://xml.zeit.de/online/2007/01/Somalia')

Build a converter:

>>> import zeit.solr.interfaces
>>> article_converter = zeit.solr.interfaces.ISolrConverter(article)
>>> article_converter
<zeit.solr.converter.SolrConverter object at 0xc5f02ac>


Convert an article and check resultset:

>>> import lxml.etree
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add xmlns:py="http://codespeak.net/lxml/objectify/pytype" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <doc>
    <field ...
  </doc>
</add>
<BLANKLINE>


Convert an image and check resultset:
>>> import zeit.cms.testing
>>> principal = zeit.cms.testing.create_interaction() 
>>> image = zeit.cms.interfaces.ICMSContent(
... 'http://xml.zeit.de/2006/DSC00109_2.JPG')
>>> with zeit.cms.checkout.helper.checked_out(image) as checked_out:
...     image_meta = zeit.content.image.interfaces.IImageMetadata(checked_out)
...     image_meta.title   = 'image title'
...     image_meta.year    = '2006'
...     image_meta.volume  = '05'
...     image_meta.alt     = 'alternative text'
...     image_meta.caption = 'caption text'
>>> image_converter = zeit.solr.interfaces.ISolrConverter(image)
>>> root_node = image_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add ...>
  <doc>
    <field name="alt">alternative text</field>
    <field name="caption">caption text</field>
    <field name="date-last-modified">...</field>
    <field name="last_modified_by">zope.user</field>
    <field name="title">image title</field>
    <field name="type">image</field>
    <field name="uuid">{urn:uuid:a429930f-f213-4dfb-b02a-441a134e0d09}</field>
    <field name="volume">5</field>
    <field name="uniqueId">http://xml.zeit.de/2006/DSC00109_2.JPG</field>
    <field name="year">2006</field>
    <field name="icon">/@@/zeit-content-image-interfaces-IImage-zmi_icon.png</field>
  </doc>
</add>
<BLANKLINE>


Convert a centerpage and check resultset:
(TODO: Use centerpage with dav properties!)

>>> cp = zeit.cms.interfaces.ICMSContent(
...     'http://xml.zeit.de/online/2007/01/index')
>>> cp_converter = zeit.solr.interfaces.ISolrConverter(cp)
>>> root_node = cp_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add xmlns:py="http://codespeak.net/lxml/objectify/pytype" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <doc>
    <field ...
  </doc>
</add>
<BLANKLINE>



Get a date
>>> import datetime
>>> import pytz
>>> date = datetime.datetime.now(tz=pytz.UTC)
>>> date
datetime.datetime...

Checkout article, change last semantic change to date, checkin
>>> dummy = with_statement
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date

>>> root_node = article_converter.convert()
>>> doc_node = root_node.doc
>>> print (doc_node.tag)
doc

Now we are doing some boosting. For today:  

>>> date = datetime.datetime.now(tz=pytz.UTC)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="7">...
...<field name="boost">7</field>...
<BLANKLINE>

For day 1
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=1)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="6">...
...<field name="boost">6</field>...
<BLANKLINE>

For day 6
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=6)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="4">...
...<field name="boost">4</field>...
<BLANKLINE>

For day 7
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=7)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="3">...
...<field name="boost">3</field>...
<BLANKLINE>

For day 20
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=20)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="3">...
...<field name="boost">3</field>...
<BLANKLINE>

For day 30
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=30)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="2">...
...<field name="boost">2</field>...
<BLANKLINE>

For day 70
>>> date = datetime.datetime.now(tz=pytz.UTC) - datetime.timedelta(days=70)
>>> with zeit.cms.checkout.helper.checked_out(article) as checked_out:
...     zeit.cms.content.interfaces.ISemanticChange(checked_out).last_semantic_change = date
>>> root_node = article_converter.convert()
>>> print lxml.etree.tostring(root_node, pretty_print=True)
<add...<doc boost="1">...
...<field name="boost">1</field>...
<BLANKLINE>


Clean up:
>>> zope.app.component.hooks.setSite(old_site)
